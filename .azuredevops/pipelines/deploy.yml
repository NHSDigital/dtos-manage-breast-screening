trigger: none
pr: none

parameters:
  - name: commitSHA
    displayName: Commit SHA
    type: string
  - name: environment
    displayName: Environment
    type: string
  - name: prNumber
    displayName: Pull request number
    type: string
    default: ''
  - name: pool
    displayName: ADO management pool
    type: string

stages:
  - stage: ${{ parameters.environment }}
    displayName: Deploy to ${{ parameters.environment }} environment
    pool:
      name: ${{ parameters.pool }}
    lockBehavior: sequential
    isSkippable: false

    jobs:
      - deployment: DeployApp
        displayName: Deploy application
        environment: ${{ parameters.environment }}
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: UsePythonVersion@0
                  inputs:
                    versionSpec: '3.x'
                    architecture: 'x64'

                - bash: |
                    TF_VERSION=$(grep "^terraform" .tool-versions | awk '{print $2}')
                    echo "##vso[task.setvariable variable=TF_VERSION]$TF_VERSION"
                  displayName: 'Get Terraform version from .tool-versions'

                - task: TerraformInstaller@1
                  displayName: Install terraform
                  inputs:
                    terraformVersion: $(TF_VERSION)

                - task: AzureCLI@2
                  displayName: Run terraform
                  inputs:
                    azureSubscription: manbrs-${{ parameters.environment }}
                    scriptType: bash
                    scriptLocation: inlineScript
                    addSpnToEnvironment: true
                    inlineScript: |
                      export ARM_TENANT_ID="$tenantId"
                      export ARM_CLIENT_ID="$servicePrincipalId"
                      export ARM_OIDC_TOKEN="$idToken"
                      export ARM_USE_OIDC=true
                      make ci ${{ parameters.environment }} terraform-apply DOCKER_IMAGE_TAG=git-sha-${{ parameters.commitSHA }} PR_NUMBER=${{ parameters.prNumber }}

                - task: AzureCLI@2
                  displayName: Run database setup
                  inputs:
                    azureSubscription: manbrs-${{ parameters.environment }}
                    scriptType: bash
                    scriptLocation: inlineScript
                    addSpnToEnvironment: true
                    inlineScript: make ci ${{ parameters.environment }} db-setup PR_NUMBER=${{ parameters.prNumber }}

                - task: AzureCLI@2
                  displayName: Run notifications smoke test
                  inputs:
                    azureSubscription: manbrs-${{ parameters.environment }}
                    scriptType: bash
                    scriptLocation: inlineScript
                    addSpnToEnvironment: true
                    inlineScript: make ci ${{ parameters.environment }} notifications-smoke-test PR_NUMBER=${{ parameters.prNumber }}
