trigger: none
pr: none

parameters:
  - name: commitSHA
    displayName: Commit SHA
    type: string
  - name: prNumber
    displayName: Pull request number
    type: string

stages:
  - stage: review
    displayName: Delete review app
    pool:
      name: private-pool-dev-uks
    isSkippable: false

    jobs:
      - deployment: DeleteReviewApp
        displayName: Delete review app
        environment: review
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - bash: |
                    TF_VERSION=$(grep "^terraform" .tool-versions | awk '{print $2}')
                    echo "##vso[task.setvariable variable=TF_VERSION]$TF_VERSION"
                  displayName: 'Get Terraform version from .tool-versions'

                - task: TerraformInstaller@1
                  displayName: Install terraform
                  inputs:
                    terraformVersion: $(TF_VERSION)

                - task: AzureCLI@2
                  displayName: Run terraform
                  inputs:
                    azureSubscription: manbrs-review
                    scriptType: bash
                    scriptLocation: inlineScript
                    addSpnToEnvironment: true
                    inlineScript: |
                      export ARM_TENANT_ID="$tenantId"
                      export ARM_CLIENT_ID="$servicePrincipalId"
                      export ARM_OIDC_TOKEN="$idToken"
                      export ARM_USE_OIDC=true
                      make ci review terraform-destroy DOCKER_IMAGE_TAG=git-sha-${{ parameters.commitSHA }} PR_NUMBER=${{ parameters.prNumber }}
