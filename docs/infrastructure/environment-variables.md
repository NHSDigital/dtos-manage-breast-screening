# Environment variables

Describe all [environment variables](deployment.md#environment-variables) and [secrets](deployment.md#application-secrets).

- Non-secret variables are stored in yaml files in `infrastructure/environments`
- Secret variables (labelled with `[Secret]`) are configured as [container app secrets](https://learn.microsoft.com/en-us/azure/container-apps/manage-secrets). They are either stored in Azure key vault or generated by terraform.

For each secret, describe the process to rotate it in case it is leaked. It may require generating or requesting a new value.

## ALLOWED_HOSTS

A list of strings representing the host/domain names that this Django site can serve. When using front door, use the internal container app domain.

## API_OAUTH_API_KEY [Secret]

Description: API Key used to sign JWT, sent to API OAuth2 provider in order to obtain a bearer token for API access. Used in conjunction with `API_OAUTH_API_KID` and `API_OAUTH_PRIVATE_KEY`.
See: https://digital.nhs.uk/developer/guides-and-documentation/security-and-authorisation/application-restricted-restful-apis-signed-jwt-authentication

To rotate: OAuth2 API keys can be regenerated using the [API Onboarding account service](https://onboarding.prod.api.platform.nhs.uk/).

## API_OAUTH_API_KID [Secret]

Description: Public/Private keypair ID used to sign JWT and sent to API OAuth2 provider. Used in conjunction with `API_OAUTH_API_KEY` and `API_OAUTH_PRIVATE_KEY`.

To rotate: [Generate a new keypair](https://digital.nhs.uk/developer/guides-and-documentation/security-and-authorisation/application-restricted-restful-apis-signed-jwt-authentication#step-2-generate-a-key-pair) and contact the NHS Notify onboarding team so they can update the public key.

## API_OAUTH_PRIVATE_KEY [Secret]

Description: Private key used to sign JWT and sent to API OAuth2 provider. Used in conjunction with `API_OAUTH_API_KID` and `API_OAUTH_API_KEY`.

To rotate: [Generate a new keypair](https://digital.nhs.uk/developer/guides-and-documentation/security-and-authorisation/application-restricted-restful-apis-signed-jwt-authentication#step-2-generate-a-key-pair) and contact the NHS Notify onboarding team so they can update the public key.

## AZURE_CLIENT_ID

Client ID of the database managed identity, when using.

## BASE_URL

Gives the Python app a canonical URL to use when generating links. Set to the FQDN in deployed environments.

## BASIC_AUTH_ENABLED

Enable HTTP basic authentication using a fixed username and password. Requires BASIC_AUTH_USERNAME and BASIC_AUTH_PASSWORD.

## BASIC_AUTH_PASSWORD [Secret]

Password for basic authentication

To rotate: generate a random word. Only used in test environments.

## BASIC_AUTH_USERNAME [Secret]

Username for basic authentication

To rotate: generate a random word. Only used in test environments.

## CIS2_CLIENT_ID [Secret]

The client ID we've registered for this service in the CIS2 Connection Manager.

To rotate:

- Shouldn't ordinarily need to rotate, as it's not expected to change.
- If there is a need to change it, fetch via the CIS2 Connection Manager and then set the new value in the Key Vault.

## CIS2_SERVER_METADATA_URL

The metadata endpoint for the CIS2 auth server, used to fetch info for the OIDC log in flow (eg - public key for JWT verification). Provided by the the CIS2 team.

## CIS2_CLIENT_PRIVATE_KEY [Secret]

Private key in PEM format. Used to sign our JWTs during the auth flow with CIS2.

To rotate:

- Run the following to generate a new key pair:

  ```
  openssl genrsa -out private.pem 2048

  openssl rsa -in private.pem -pubout -out public.pem
  ```

- With these files created locally, update the key vault with the new private key, following the instructions for [multi-line secrets](deployment.md#multi-line-secrets).

## CIS2_CLIENT_PUBLIC_KEY [Secret]

Public key in PEM format. Used by CIS2to verify the signature of JWTs during the auth flow with CIS2.

To rotate:

- As above for the CIS2 private key, ensuring the public.pem file is used to update the key vault.

## DATABASE_HOST

Postgres server hostname

## DATABASE_NAME

Postgres database inside DATABASE_HOST

## DATABASE_PASSWORD [Secret]

Postgres server admin user password. Not used when using managed identity.

To rotate: only used in review apps. Close the pull request to delete the environment.

## DATABASE_PORT

Postgres server port. Defaults to 5432. Required for review apps as each database container must have a unique port.

## DATABASE_USER

Database server admin user name. When using a managed identity, name of the managed identity.

## DJANGO_ENV

Specifies the Django environment configuration. This variable controls environment-specific behaviour throughout the application. It's primarily for ensuring non-production code is not run or made available in production.

**Example values:**

- `production` (default)
- `dev`

**Example usage:**

- When not set to "production", enables the `nonprod` Django app which provides development utilities
- The `seed_demo_data` management command checks this env var to prevent execution in production environments

## NHS_NOTIFY_API_KEY [Secret]

Description: API Key used in HMAC signature verification when processing callback HTTP requests from NHS Notify API.

To rotate: Contact NHS Notify onboarding team to obtain new API key.

## NHS_NOTIFY_APPLICATION_ID [Secret]

Description: Identifier shared between NHS Notify API and client application used in HMAC signature verification for callback HTTP requests.

To rotate: Contact NHS Notify onboarding team to obtain new application ID.

## PERSONAS_ENABLED

Enable personas to simulate logins with different users. Set to "1" to enable, do not set to disable.

## SECRET_KEY [Secret]

This value [the SECRET_KEY setting] is the key to securing signed data â€“ it is vital you keep this secure, or attackers could use it to generate their own signed values.

To rotate: generate a new random key

## SSL_MODE

[SSL mode](https://www.postgresql.org/docs/current/libpq-ssl.html#LIBPQ-SSL-PROTECTION) of the client connection to the Postgres server. Set to "require" on deployed environments.
