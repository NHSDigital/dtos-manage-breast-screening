# Create an environment

This is the initial manual process to create a new environment like review, dev, production...
- Create the configuration files in `infrastructure/environments/[environment]`
- Create postgres Entra ID group in DTOS Administrative Unit (AU): `postgres_manbrs_[environment]_uks_admin`
- Run bicep from AVD: `make [environment] resource-group-init`
- Ask CCOE to assign role:
	- [Form for PIM](https://nhsdigitallive.service-now.com/nhs_digital?id=sc_cat_item&sys_id=28f3ab4f1bf3ca1078ac4337b04bcb78&sysparm_category=114fced51bdae1502eee65b9bd4bcbdc) or [Generic infrastructure form]([https://nhsdigitallive.service-now.com/nhs_digital?id=sc_cat_item&sys_id=bd7112991bdae1502eee65b9bd4bcb3b&referrer=popular_items](https://nhsdigitallive.service-now.com/nhs_digital?id=sc_cat_item&sys_id=bd7112991bdae1502eee65b9bd4bcb3b&referrer=popular_items))
	- Managed identity: `mi-manbrs-[environment]-uks`
	- role: permanent PIM Groups reader on Directory
- Create ADO group
	- Name: `Run pipeline - [environment]`
	- Members: `mi-manbrs-ado-[environment]-aks`. There may be more than 1 in the list. Check client id printed below the name.
	- Permissions:
		- View project-level information
- Create new pipeline:
    - Name: `Deploy to Azure - [environment]`
    - Pipeline yaml: `.azuredevops/pipelines/deploy.yml`
- Manage pipeline security:
	- Add group: `Run pipeline - [environment]`
	- Permissions:
		- Edit queue build configuration
		- Queue builds
		- View build pipeline
- Create ADO environment: [environment]
	- Set: exclusive lock
	- Add pipeline permission for `Deploy to Azure - [environment]` pipeline
- Create Github environment [environment]
- Add environment secrets, from `mi-manbrs-ado-[environment]-uks`
	- AZURE_CLIENT_ID
	- AZURE_SUBSCRIPTION_ID
- Create service connection
	- Connection type: `Azure Resource Manager`
	- Identity type: `Managed identity`
	- Subscription: `Digital Screening DToS - DevOps`
	- Resource group: `rg-mi-[environment]-uks`
	- Managed identity: `mi-manbrs-[environment]-uks`
- Scope level: Subscription
- Subscription: `Digital Screening DToS - Core Services Dev`
- Service Connection Name: `manbrs-[environment]`
- Do NOT tick: Grant access permission to all pipelines
- Add environment to the list of environment in `deploy-stage` step of `cicd-2-main-branch.yaml`. For the review enviornment, there is a single item in `cicd-1-pull-request.yaml`.
- Run Github workflow
- Check ADO pipeline. You may be prompted to authorise:
	- Pipeline: service connection
	- Environment: service connection and agent pool
