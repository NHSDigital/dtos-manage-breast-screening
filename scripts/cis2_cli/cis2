#!/usr/bin/env python3
"""
NHS CIS2 Connection Manager CLI Tool

A command-line interface for interacting with the NHS CIS2 Connection Manager API.
Supports authentication and configuration management operations.
"""

import getpass
import json
import sys
from typing import Any, Dict, Optional

import requests


class CIS2Client:
    """Client for interacting with the NHS CIS2 Connection Manager API."""

    BASE_URL = "https://connectionmanager.nhsint.auth-ptl.cis2.spineservices.nhs.uk"

    def __init__(self):
        self.session = requests.Session()
        self.access_token: Optional[str] = None
        self.team_id: Optional[str] = None
        self.secret: Optional[str] = None

    def authenticate(self, secret: str) -> Dict[str, Any]:
        """Authenticate with the API using the provided secret."""
        url = f"{self.BASE_URL}/api/auth"
        headers = {
            "Authorization": f"SecretAuth {secret}",
            "Content-Type": "application/json",
        }

        try:
            response = self.session.post(url, headers=headers)
            response.raise_for_status()

            auth_data = response.json()
            self.access_token = auth_data.get("access_token")
            self.secret = secret

            # Update session headers with access token
            if self.access_token:
                self.session.headers.update(
                    {"Authorization": f"Bearer {self.access_token}"}
                )

            return auth_data
        except requests.exceptions.RequestException as e:
            raise Exception(f"Authentication failed: {e}")

    def get_configs(self, team_id: str) -> Dict[str, Any]:
        """Get list of configs for the specified team."""
        url = f"{self.BASE_URL}/api/configs/{team_id}"

        try:
            response = self.session.get(url)
            response.raise_for_status()
            return response.json()
        except requests.exceptions.RequestException as e:
            raise Exception(f"Failed to get configs: {e}")

    def get_config(self, team_id: str, config_id: str) -> Dict[str, Any]:
        """Get a specific config by ID for the specified team."""
        url = f"{self.BASE_URL}/api/configs/{team_id}/{config_id}"

        try:
            response = self.session.get(url)
            response.raise_for_status()
            return response.json()
        except requests.exceptions.RequestException as e:
            raise Exception(f"Failed to get config: {e}")

    def create_config(self, team_id: str, payload: Dict[str, Any]) -> Dict[str, Any]:
        """Create a new config with full payload support."""
        url = f"{self.BASE_URL}/api/configs/{team_id}"

        try:
            response = self.session.post(url, json=payload)
            response.raise_for_status()
            return response.json()
        except requests.exceptions.RequestException as e:
            # For HTTP errors, try to get detailed error information from response
            if hasattr(e, "response") and e.response is not None:
                try:
                    error_detail = e.response.json()
                    raise Exception(
                        f"Failed to create config (HTTP {e.response.status_code}): {json.dumps(error_detail, indent=2)}"
                    )
                except (ValueError, json.JSONDecodeError):
                    # If response isn't JSON, show the raw text
                    raise Exception(
                        f"Failed to create config (HTTP {e.response.status_code}): {e.response.text}"
                    )
            else:
                raise Exception(f"Failed to create config: {e}")


class CIS2CLI:
    """Command-line interface for the CIS2 Connection Manager."""

    def __init__(self):
        self.client = CIS2Client()

    def setup_credentials(self):
        """Prompt user for secret and team ID, then authenticate."""
        # Get secret
        secret = getpass.getpass("Enter your API secret: ")
        if not secret:
            print("Error: Secret is required")
            sys.exit(1)

        # Authenticate
        try:
            print("Authenticating with CIS2...")
            auth_result = self.client.authenticate(secret)
            print("✓ Authentication successful")

            # Handle team ID selection
            if "team_ids" not in auth_result or not auth_result["team_ids"]:
                print("✗ Error: No team IDs available for this account")
                print(
                    "Please contact your administrator to ensure your account has team access."
                )
                sys.exit(1)

            team_ids = auth_result["team_ids"]

            print("\nAvailable team IDs:")
            for i, team_id in enumerate(team_ids, 1):
                print(f"{i}. {team_id}")

            while True:
                try:
                    choice = input(f"Select team ID (1-{len(team_ids)}): ").strip()
                    choice_num = int(choice)

                    if 1 <= choice_num <= len(team_ids):
                        selected_team_id = team_ids[choice_num - 1]
                        self.client.team_id = selected_team_id
                        print(f"✓ Team ID set to: {selected_team_id}")
                        break
                    else:
                        print(
                            f"Invalid choice. Please enter a number between 1 and {len(team_ids)}."
                        )
                except ValueError:
                    print("Invalid input. Please enter a number.")
                except KeyboardInterrupt:
                    print("\nOperation cancelled.")
                    sys.exit(1)

        except Exception as e:
            print(f"✗ Authentication failed: {e}")
            sys.exit(1)

        print()

    def show_menu(self):
        """Display the main menu options."""
        print("Available options:")
        print("1. Create new configuration")
        print("2. Display specific configuration")
        print("3. Quit")
        print()

    def display_config(self):
        """Display details of a specific configuration."""
        try:
            # First, get the list of available configurations
            print(f"Fetching configs for team {self.client.team_id}...")
            configs_response = self.client.get_configs(self.client.team_id)

            # Extract config IDs from the response
            config_ids = configs_response.get("configs", [])

            if not config_ids:
                print("✗ Error: No configurations available for this team")
                return

            # Show numbered menu for selection
            print("\nAvailable configurations:")
            for i, config_id in enumerate(config_ids, 1):
                print(f"{i}. {config_id}")

            while True:
                try:
                    choice = input(
                        f"Select configuration (1-{len(config_ids)}): "
                    ).strip()
                    choice_num = int(choice)

                    if 1 <= choice_num <= len(config_ids):
                        selected_config_id = config_ids[choice_num - 1]
                        print()
                        break
                    else:
                        print(
                            f"Invalid choice. Please enter a number between 1 and {len(config_ids)}."
                        )
                except ValueError:
                    print("Invalid input. Please enter a number.")
                except KeyboardInterrupt:
                    print("\nOperation cancelled.")
                    return

            # Fetch and display the selected configuration
            print(f"Fetching config '{selected_config_id}'...")
            config = self.client.get_config(self.client.team_id, selected_config_id)

            print(f"\nConfiguration Details for '{selected_config_id}':")
            print("=" * 40)
            print(json.dumps(config, indent=2))

        except Exception as e:
            print(f"✗ Error displaying config: {e}")

    def create_config(self):
        """Create a new configuration."""
        try:
            print("Create new configuration")
            print("-" * 25)

            client_name = input("Enter client name: ").strip()
            if not client_name:
                print("Error: Client name is required")
                return

            redirect_uris_input = input(
                "Enter redirect URIs (comma-separated): "
            ).strip()
            if not redirect_uris_input:
                print("Error: At least one redirect URI is required")
                return

            redirect_uris = [uri.strip() for uri in redirect_uris_input.split(",")]

            # Get optional fields
            description = input("Enter description (optional): ").strip() or None

            backchannel_logout_uri = (
                input("Enter backchannel logout URI (optional): ").strip() or None
            )

            print("\nAuthentication method:")
            print("1. client_secret_post (default)")
            print("2. private_key_jwt")
            auth_choice = (
                input("Choose authentication method (1-2, default 1): ").strip() or "1"
            )

            token_endpoint_auth_method = "client_secret_post"
            jwks_uri = None
            jwks_uri_signing_algorithm = None

            if auth_choice == "2":
                token_endpoint_auth_method = "private_key_jwt"
                jwks_uri = input(
                    "Enter JWKS URI (required for private_key_jwt): "
                ).strip()
                if not jwks_uri:
                    print("Error: JWKS URI is required when using private_key_jwt")
                    return

                jwks_uri_signing_algorithm = (
                    input("Enter JWKS URI signing algorithm (e.g., RS512): ").strip()
                    or None
                )

            # Build payload with only non-None values
            payload = {
                "client_name": client_name,
                "redirect_uris": redirect_uris,
                "token_endpoint_auth_method": token_endpoint_auth_method,
            }

            if description:
                payload["description"] = description
            if backchannel_logout_uri:
                payload["backchannel_logout_uri"] = backchannel_logout_uri
            if jwks_uri:
                payload["jwks_uri"] = jwks_uri
            if jwks_uri_signing_algorithm:
                payload["jwks_uri_signing_algorithm"] = jwks_uri_signing_algorithm

            print()
            print(f"Creating config for team {self.client.team_id}...")
            print("Payload:")
            print(json.dumps(payload, indent=2))
            print()

            result = self.client.create_config(self.client.team_id, payload)

            print("✓ Config created")
            print(json.dumps(result, indent=2))

        except Exception as e:
            print(f"✗ Error creating config: {e}")

    def run(self):
        """Run the CLI application."""
        # Initial setup
        self.setup_credentials()

        # Main loop
        while True:
            self.show_menu()

            try:
                choice = input("Enter your choice (1-3): ").strip()
                print()

                if choice == "1":
                    self.create_config()
                elif choice == "2":
                    self.display_config()
                elif choice == "3":
                    print("Goodbye!")
                    break
                else:
                    print("Invalid choice. Please enter 1-3.")

                print()

            except KeyboardInterrupt:
                print("\n\nGoodbye!")
                break
            except Exception as e:
                print(f"Unexpected error: {e}")


if __name__ == "__main__":
    cli = CIS2CLI()
    cli.run()
